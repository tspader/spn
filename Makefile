SPN_EXAMPLES := hello scratch

SPN_DIR_BUILD:= build
  SPN_DIR_BUILD_EXAMPLES := $(SPN_DIR_BUILD)/examples
  	SPN_EXAMPLE_BINARY_HELLO := $(SPN_DIR_BUILD_EXAMPLES)/hello
  	SPN_EXAMPLE_BINARY_SDL := $(SPN_DIR_BUILD_EXAMPLES)/sdl
  	SPN_EXAMPLE_BINARY_SQLITE := $(SPN_DIR_BUILD_EXAMPLES)/sqlite
  SPN_DIR_BUILD_OUTPUT := $(SPN_DIR_BUILD)/bin
    SPN_BINARY := $(SPN_DIR_BUILD_OUTPUT)/spn
    SPN_TEST_BINARY := $(SPN_DIR_BUILD_OUTPUT)/spn-test
    SDL_BINARY := $(SPN_DIR_BUILD_OUTPUT)/libSDL3.so
  SPN_DIR_BUILD_SDL := $(SPN_DIR_BUILD)/sdl
SPN_DIR_SOURCE := source
SPN_DIR_EXTERNAL := external
  SPN_DIR_SP := $(SPN_DIR_EXTERNAL)/sp
    SPN_SP_H := $(SPN_DIR_SP)/sp.h
  SPN_DIR_ARGPARSE := $(SPN_DIR_EXTERNAL)/argparse
  SPN_DIR_SDL := $(SPN_DIR_EXTERNAL)/SDL
    SPN_DIR_SDL_INCLUDE := $(SPN_DIR_SDL)/include
SPN_DIR_EXAMPLES := examples
	SPN_DIR_EXAMPLE_HELLO := $(SPN_DIR_EXAMPLES)/hello
	SPN_DIR_EXAMPLE_SDL := $(SPN_DIR_EXAMPLES)/sdl
	SPN_DIR_EXAMPLE_SQLITE := $(SPN_DIR_EXAMPLES)/sqlite
SPN_DIR_TEST := test
SPN_MAKEFILE := Makefile
SPN_COMPILE_DB := compile_commands.json
SPN_CLANGD := .clangd
SPN_DIR_CACHE := ~/.cache/spn/repos/spn

BUILD_TYPE ?= debug
CMAKE_TYPE := Debug
MAKEFLAGS += -j8
CC := bear --append -- gcc
MAKE := bear --append -- make
CMAKE := bear --append -- cmake

SPN_FLAG_LANGUAGE := -std=c11
SPN_FLAG_INCLUDES := -I$(SPN_DIR_EXTERNAL) -I$(SPN_DIR_SP) -I$(SPN_DIR_ARGPARSE) -I$(SPN_DIR_SDL) -I$(SPN_DIR_SOURCE)
SPN_FLAG_OUTPUT := -o $(SPN_BINARY)
SPN_FLAG_OPTIMIZATION := -g
SPN_FLAG_LIBS := -lSDL3
SPN_CC_FLAGS := $(SPN_FLAG_LANGUAGE) $(SPN_FLAG_INCLUDES) $(SPN_FLAG_OUTPUT) $(SPN_FLAG_OPTIMIZATION) $(SPN_FLAG_LIBS)

SPN_TEST_FLAG_OUTPUT := -o $(SPN_TEST_BINARY)
SPN_TEST_CC_FLAGS := $(SPN_FLAG_LANGUAGE) $(SPN_FLAG_INCLUDES) $(SPN_TEST_FLAG_OUTPUT) $(SPN_FLAG_OPTIMIZATION) $(SPN_FLAG_LIBS)

SPN_DEPS := $(SPN_DIR_SOURCE)/spn.h $(SPN_DIR_SP)/sp.h $(SDL_BINARY)

SPN_CLANGD_HEADER_ONLY_BULLSHIT := -DSP_OS_BACKEND_SDL, -DSP_IMPLEMENTATION, -DSPN_IMPLEMENTATION, -include, toml/toml.h, -include, argparse/argparse.h, -include, sp/sp.h, -include, SDL3/SDL.h, -Wno-macro-redefined, -Wno-unused-includes

SDL_FLAG_DEFINES := -DCMAKE_BUILD_TYPE=$(CMAKE_TYPE) -DSDL_SHARED=ON -DSDL_STATIC=OFF -DSDL_TEST=OFF -DSDL_EXAMPLES=OFF
SDL_CMAKE_FLAGS := $(SDL_FLAG_DEFINES)

EXAMPLE_FLAG_LANGUAGE := -std=c11
EXAMPLE_FLAG_OPTIMIZATION := -g
EXAMPLE_CC_FLAGS := $(EXAMPLE_FLAG_LANGUAGE) $(EXAMPLE_FLAG_OPTIMIZATION)

.PHONY: all
all: build examples clangd

$(SPN_DIR_BUILD_OUTPUT):
	@mkdir -p $(SPN_DIR_BUILD_OUTPUT)

$(SPN_DIR_BUILD_SDL):
	@mkdir -p $(SPN_DIR_BUILD_SDL)

$(SPN_DIR_BUILD_EXAMPLES):
	@mkdir -p $(SPN_DIR_BUILD_EXAMPLES)

$(SDL_BINARY): $(SPN_DIR_BUILD_SDL)
	$(CMAKE) -S$(SPN_DIR_SDL) -B$(SPN_DIR_BUILD_SDL) $(SDL_CMAKE_FLAGS)
	$(CMAKE) --build $(SPN_DIR_BUILD_SDL) --parallel
	cp $(SPN_DIR_BUILD_SDL)/libSDL3.so $(SPN_DIR_BUILD_OUTPUT)

$(SPN_BINARY): $(SPN_DIR_SOURCE)/main.c $(SPN_DEPS)
	$(CC) $(SPN_CC_FLAGS) $(SPN_DIR_SOURCE)/main.c

$(SPN_TEST_BINARY): $(SPN_DIR_TEST)/main.c $(SPN_DEPS)
	$(CC) $(SPN_TEST_CC_FLAGS) $(SPN_DIR_TEST)/main.c

$(SPN_COMPILE_DB): $(SPN_MAKEFILE)

$(SPN_CLANGD): $(SPN_COMPILE_DB)
	@printf "CompileFlags:\n  Add: [$(SPN_CLANGD_HEADER_ONLY_BULLSHIT)]\n" > $(SPN_CLANGD)

$(SPN_EXAMPLE_BINARY_HELLO): $(SPN_BINARY) | $(SPN_DIR_BUILD_EXAMPLES)
	$(MAKE) -C $(SPN_DIR_EXAMPLE_HELLO)

$(SPN_EXAMPLE_BINARY_SDL): $(SPN_BINARY) | $(SPN_DIR_BUILD_EXAMPLES)
	$(MAKE) -C $(SPN_DIR_EXAMPLE_SDL)

$(SPN_EXAMPLE_BINARY_SQLITE): $(SPN_BINARY) | $(SPN_DIR_BUILD_EXAMPLES)
	$(MAKE) -C $(SPN_DIR_EXAMPLE_SQLITE)

.PHONY: build sdl clangd clean nuke test

build: $(SPN_BINARY)

test: $(SPN_TEST_BINARY)
	$(SPN_TEST_BINARY)

sdl: $(SDL_BINARY)

clangd: $(SPN_COMPILE_DB) $(SPN_CLANGD)

clean:
	@rm -rf $(SPN_DIR_BUILD_OUTPUT)
	@rm -rf $(SPN_DIR_BUILD_EXAMPLES)
	@rm -f $(SPN_COMPILE_DB)
	@rm -f $(SPN_CLANGD)

nuke:
	@rm -rf $(SPN_DIR_BUILD)
	@rm -f $(SPN_COMPILE_DB)
	@rm -f $(SPN_CLANGD)

examples: example-hello example-sdl example-sqlite | $(SPN_DIR_BUILD_EXAMPLES)

example-hello: $(SPN_EXAMPLE_BINARY_HELLO)
example-sdl: $(SPN_EXAMPLE_BINARY_SDL)
example-sqlite: $(SPN_EXAMPLE_BINARY_SQLITE)
